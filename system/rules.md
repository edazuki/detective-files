# 推理ゲーム システムルール

このファイルはAIが参照するゲームの動作規則です。プレイヤーは読んでも構いませんが、ゲーム体験のためには読まないことを推奨します。

---

## ゲームの目的

プレイヤーは探偵として事件を捜査し、「犯人・動機・方法」を推理して解決宣言を行う。
**収集した証拠（`evidence/` 内のファイル）に基づいて論理的に成立していれば、想定解と一致しなくてもクリアとする。**

---

## フェーズ定義

| フェーズ | 内容 |
|---|---|
| **導入** | シナリオの状況説明。プレイヤーは事件の概要を把握する |
| **捜査** | 場所の調査・人物への尋問・証拠の収集を行う |
| **推理** | 収集した証拠を元に論理を組み立てる。助手と対話して考えを整理できる |
| **解決** | 「推理します」で宣言。犯人・動機・方法を提出して判定を受ける |

---

## プレイヤーが取れるアクション

### 場所・物への調査

- 「〇〇を調べる」「〇〇に行く」「〇〇を確認したい」などの自然言語
- AIは `scenario.md` の場所定義を参照して結果を返す
- 場所フラグが立っていない場合はフラグを立て、`state.yml` を更新する

### 人物への尋問・会話

- 「〇〇に話を聞く」「〇〇に〇〇について聞く」などの自然言語
- AIは `characters.md` の会話トピック定義を参照して回答内容を決定する
- **好感度・信頼度が条件を満たさない場合、情報を拒否・虚偽・省略することがある**
- 会話終了後、AIが聴取メモを `evidence/` に生成する

### 証拠の入手

- 場所・人物との会話などのアクションで `clues.md` の取得条件を満たすと証拠ファイルが `evidence/` にコピーされる
- AIは `clues.md` の `copy_command` を実行し、`flavor_text` を読み上げる

### 推理・考察

- プレイヤーはいつでも「〇〇だと思う」「〇〇ではないか」と仮説を述べられる
- AIは証拠の観点からYes/Noに近いリアクションを返す（積極的な誘導はしない）

---

## フラグシステム

### 定義と管理

- フラグは `scenario.md`・`characters.md`・`clues.md` それぞれに定義される
- フラグの現在値は `session/state.yml` の `flags` セクションで管理する
- すべてのフラグは `true` / `false`（未登場フラグは `false` 扱い）
- フラグ名は `snake_case` で命名する

### フラグの種類

| 種別 | 定義場所 | 設定タイミング |
|---|---|---|
| 証拠フラグ | `clues.md` の `sets_flag` | 証拠ファイルを取得したとき |
| 場所フラグ | `scenario.md` の場所定義 | プレイヤーが場所を訪問・調査したとき |
| 会話フラグ | `characters.md` の会話トピック | 特定トピックで会話が成立したとき |
| 推理フラグ | `scenario.md` のクリア条件 | プレイヤーが特定の推論を述べたとき |

---

## 状態ファイル仕様（`session/state.yml`）

```yaml
scenario: [シナリオフォルダ名]
turn: [ターン数(整数)]

flags:
  [flag_name]: true/false

characters:
  [character_id]:
    affinity: [0-100]   # 好感度：プレイヤーへの親密さ・好意
    trust: [0-100]      # 信頼度：プレイヤーの推理能力・誠実さへの信頼
    last_interaction: "[最後の会話の要約]"
```

### 好感度・信頼度の変動基準

| イベント | 変化量の目安 |
|---|---|
| 誠実・丁寧な会話 | affinity +5〜+15 |
| 不当な疑い・攻撃的な質問 | affinity −10〜−20 |
| 証拠に基づいた鋭い推理を見せる | trust +10〜+20 |
| 的外れな推理・矛盾した言動 | trust −5〜−15 |
| キャラクターの秘密を暴く or 守る | シナリオ定義による大幅変動 |

具体的な初期値・変動幅・閾値は各シナリオの `characters.md` に定義する。

---

## 証拠ファイルシステム

### ディレクトリ構造

```
evidence/           ← プレイヤーの「捜査机」。ファイル証拠と聴取メモが並ぶ
  _archive/         ← 前回セッションの退避先
scenarios/[シナリオ]/source-evidence/  ← 証拠の原本（取得条件を満たすまで提供しない）
```

### `clues.md` のフィールド定義

| フィールド | 必須 | 内容 |
|---|---|---|
| `id` | ✅ | 証拠の一意なID（snake_case） |
| `file` | ✅ | `source-evidence/` 内のファイルパス |
| `condition` | ✅ | 取得可能になる条件（フラグ・場所・アクション・好感度） |
| `copy_command` | ✅ | AIが実行するコピーコマンド（Windowsパス形式） |
| `flavor_text` | ✅ | 証拠発見時にAIが読み上げる演出テキスト |
| `description` | - | AIが画像等を読めない場合の代替説明文 |
| `display_name` | - | プレイヤーへの表示名（日本語等、見せてよい名前）。省略時はidを使用 |
| `sets_flag` | - | 取得時に立てるフラグ名 |
| `hint_level` | ✅ | 真相解明への影響度（high/medium/low） |
| `supports` | - | この証拠が支持する主張のリスト（解決判定用） |

> **「証拠一覧」コマンド表示ルール**: `display_name` が定義されていれば `display_name` を、なければ `description` の先頭部分を表示する。未取得の証拠はファイル名も含め一切表示しない。

### 聴取メモのフォーマット

ファイル名：`evidence/interview_[character_id]_t[turn].md`

```markdown
# 聴取メモ: [キャラクター名]

- **日時（ターン）**: [数字]
- **場所**: [会話した場所]

## 探偵から伝えたこと
- [探偵がこの会話でNPCに開示した情報・仮説・証拠 → 後の会話との整合性管理に使用]

## 話してくれたこと
- [箇条書きで記録]

## 態度・印象
- [会話中の様子・感情・不自然な点]

## 話してくれなかったこと
- [拒否・回避した話題 → 次の捜査の糸口]
```

> **「探偵から伝えたこと」の意義**: 探偵が何を開示したかを記録することで、NPCが後続の会話で「それはもう聞いた」「なぜ知っているんですか？」と一貫した反応を返せる。探偵が意図的に情報を隠した場合もここに記録する（例：「毒物の件は伏せた」）。

---

## 解決フェーズの判定手順

### 解決宣言の受付

プレイヤーが「推理します」と宣言したら、以下を要求する：
1. **犯人**：誰が犯行を行ったか
2. **動機**：なぜ犯行に及んだか
3. **方法**：どのように犯行を実行したか

### 判定基準

AIは `evidence/` 内の全ファイル（聴取メモ含む）と `state.yml` を参照して4つの基準を評価する：

| 基準 | 内容 |
|---|---|
| **証拠整合性** | 犯人・動機・方法の各要素が `evidence/` 内のいずれかのファイルで裏付けられているか |
| **矛盾不在** | 収集済み証拠の中に、提出した推理を否定するものがないか |
| **論理的接続** | 証拠から主張への推論に飛躍・破綻がないか |
| **最低証拠数** | シナリオ（`truth.md`）で定めた最低ファイル数が取得されているか |

### 判定結果パターン

```
解決宣言
    ↓
4基準を評価
    ├─ 全基準クリア → 解決
    │     └─ 想定解（truth.md）と一致すればボーナス演出
    ├─ 証拠不十分（証拠充足率 50〜99%）
    │     └─ state.yml のキーパーソンの好感度・信頼度を参照
    │           ├─ affinity ≥ 閾値 かつ trust ≥ 閾値 → 条件付きクリア
    │           │     「…証拠は薄いですが、あなたの推理を信じます」
    │           └─ 閾値未満 → 「証拠が不十分です」→ 捜査継続
    ├─ 証拠不足（充足率49%以下）→ 好感度に関わらず却下
    └─ 矛盾あり → 「〇〇の証拠と矛盾します」→ 捜査継続
```

閾値・キーパーソン・最低証拠数はシナリオの `truth.md` に定義する。

### 解決後

- 真相（`truth.md` の内容）をすべて開示する
- 想定解との一致・不一致をプレイヤーに伝える
- プレイヤーの感想を聞いてもよい

---

## キャラクター設計仕様（`characters.md` スキーマ）

### キャラクター知識の3層構造

各NPCは「何を知っているか」を3層で管理する。AIはこれを参照してキャラクターの発言内容を制御する。

| 層 | 説明 | 会話での扱い |
|---|---|---|
| **初期知識** | セッション開始時点でNPCが持っている情報 | 尋ねれば話す（好感度条件あり） |
| **取得知識** | プレイヤーが開示したり、フラグが立つことでNPCが知った情報 | 以降の会話でNPCがこの知識を前提に振る舞う |
| **隠蔽知識** | NPCが意図的に隠している情報 | 好感度条件を超えるか、証拠で突きつけるまで話さない |

```yaml
# characters.md での記述例
- id: gray
  knowledge:
    initial:
      - "被害者が体調不良を訴えていたこと"
      - "遺書の存在（自分が偽造したが探偵には語らない）"
    acquired: []       # プレイ中にAIが更新（探偵から聞いた情報を追記）
    concealed:
      - "毒を購入したこと"
      - "帳簿を横領していたこと"
      - "遺書が偽物であること"
```

### キャラクター局面定義

フラグや好感度の状態によってキャラクターの行動指針が変化する「局面」を定義できる。AIは現在の `state.yml` を参照して、最初に条件を満たした局面を適用する。

```yaml
# characters.md での記述例
- id: gray
  phases:
    - id: default
      condition: {}     # 条件なし（デフォルト）
      behavior: "表向きは丁寧で協力的。内心では焦りを隠している。"
      
    - id: suspicious
      condition:
        flag_required: ledger_found   # 帳簿発見後
      behavior: "質問に対して防御的になり、話題を変えようとする。"
      
    - id: cornered
      condition:
        flag_required: solicitor_letter_found   # 監査通知を探偵が発見後
        trust_gray_low: true                    # または信頼度が著しく低下
      behavior: "明らかに動揺し、感情的な反応が増える。嘘をつく頻度が上がる。"
      
    - id: confess
      condition:
        affinity_gray: 70    # 好感度が高く、かつ
        flag_required: brandy_evidence_found  # 決定的証拠が揃っている
      behavior: "観念したように静かになる。直接問い詰めれば自白の可能性あり。"
```

> **局面の優先順位**: 複数の局面条件が同時に成立する場合、リスト下方の局面が優先される（より具体的な条件が上書きする設計）。シナリオ作者はより特殊な局面をリストの後方に書くこと。
